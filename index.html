<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventarios y Producci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background-color: #1e40af;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem;
            padding: 12px;
        }
        td {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        input[type="number"] {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: right;
            background-color: #fff;
        }
        .editable-text:hover {
            background-color: #fef9c3;
            cursor: pointer;
        }
        .total-row {
            background-color: #eff6ff;
            font-weight: bold;
        }
        .handwritten-note {
            font-style: italic;
            color: #b91c1c;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
            border-bottom: 1px dashed #f87171;
            width: fit-content;
        }
        .total-display {
            font-weight: bold;
            text-align: right;
            color: #1e40af;
        }
        @media print {
            .print\:hidden { display: none; }
            body { background-color: white; }
            .table-container { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <h1 contenteditable="true" id="main-title" onblur="saveState()" class="editable-text text-2xl font-bold text-center mb-8 text-blue-900 border-b-2 border-blue-900 pb-2 uppercase">
            HOJA DE CONTROL DE PRODUCCI√ìN Y REPROCESO
        </h1>

        <!-- TABLAS PRINCIPALES -->
        <div id="capture-area">
            <!-- 1. INVENTARIOS REPROCESO -->
            <div class="table-container">
                <table id="table-1">
                    <thead>
                        <tr>
                            <th class="text-left" style="width: 50px;">#</th>
                            <th contenteditable="true" onblur="saveState()" class="editable-text text-left">INVENTARIOS REPROCESO</th>
                            <th style="width: 150px;">1</th>
                            <th style="width: 150px;">2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="font-bold">1</td><td contenteditable="true" onblur="saveState()" class="editable-text">REPROCESO EN SILOS</td><td><input type="number" class="col-1 data-input" data-id="r1-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="r1-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">REPROCESO EN PISO</td><td><input type="number" class="col-1 data-input" data-id="r2-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="r2-c2" oninput="updateCalculations()"></td></tr>
                        <tr class="total-row"><td></td><td class="text-right">TOTAL REPROCESO:</td><td class="total-display" id="total-1-1">0</td><td class="total-display" id="total-1-2">0</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 2. GENERACION -->
            <span contenteditable="true" id="note-2" onblur="saveState()" class="handwritten-note editable-text">Desperdicio de cada l√≠nea</span>
            <div class="table-container">
                <table id="table-2">
                    <thead>
                        <tr>
                            <th class="text-left" style="width: 50px;">#</th>
                            <th contenteditable="true" onblur="saveState()" class="editable-text text-left">GENERACI√ìN</th>
                            <th style="width: 150px;">1</th>
                            <th style="width: 150px;">2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="font-bold">2</td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA LARGAS 2400</td><td><input type="number" class="col-1 data-input" data-id="g1-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g1-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA FIDEO NUEVA</td><td><input type="number" class="col-1 data-input" data-id="g2-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g2-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA PASTA CORTA 01</td><td><input type="number" class="col-1 data-input" data-id="g3-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g3-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA PASTA CORTA 02</td><td><input type="number" class="col-1 data-input" data-id="g4-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g4-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA LARGAS 1700</td><td><input type="number" class="col-1 data-input" data-id="g5-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g5-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA FIDEO MADRIGAL</td><td><input type="number" class="col-1 data-input" data-id="g6-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="g6-c2" oninput="updateCalculations()"></td></tr>
                        <tr class="total-row"><td></td><td class="text-right">ACUMULADO DEL DIA (kgs):</td><td class="total-display" id="total-2-1">0</td><td class="total-display" id="total-2-2">0</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 3. CONSUMO DIARIO -->
            <span contenteditable="true" id="note-3" onblur="saveState()" class="handwritten-note editable-text">CANTIDAD DE HARINA QUE SE MAND√ì A CADA L√çNEA</span>
            <div class="table-container">
                <table id="table-3">
                    <thead>
                        <tr>
                            <th class="text-left" style="width: 50px;">#</th>
                            <th contenteditable="true" onblur="saveState()" class="editable-text text-left">CONSUMO DIARIO</th>
                            <th style="width: 150px;">1</th>
                            <th style="width: 150px;">2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="font-bold">3</td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA LARGAS 2400</td><td><input type="number" class="col-1 data-input" data-id="h1-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="h1-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA FIDEO NUEVA</td><td><input type="number" class="col-1 data-input" data-id="h2-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="h2-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA PASTA CORTA 01</td><td><input type="number" class="col-1 data-input" data-id="h3-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-id" data-id="h3-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA PASTA CORTA 02</td><td><input type="number" class="col-1 data-input" data-id="h4-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="h4-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA LARGAS 1700</td><td><input type="number" class="col-1 data-input" data-id="h5-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="h5-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">LINEA FIDEO MADRIGAL</td><td><input type="number" class="col-1 data-input" data-id="h6-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="h6-c2" oninput="updateCalculations()"></td></tr>
                        <tr class="total-row"><td></td><td class="text-right">ACUMULADO DEL DIA (kgs):</td><td class="total-display" id="total-3-1">0</td><td class="total-display" id="total-3-2">0</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 4. MOLIENDA -->
            <div class="table-container">
                <table id="table-4">
                    <thead>
                        <tr>
                            <th class="text-left" style="width: 50px;">#</th>
                            <th contenteditable="true" onblur="saveState()" class="editable-text text-left">MOLIENDA</th>
                            <th style="width: 150px;">1</th>
                            <th style="width: 150px;">2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="font-bold">4</td><td contenteditable="true" onblur="saveState()" class="editable-text">PRIMER TURNO:</td><td><input type="number" class="col-1 data-input" data-id="m1-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="m1-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">SEGUNDO TURNO:</td><td><input type="number" class="col-1 data-input" data-id="m2-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="m2-c2" oninput="updateCalculations()"></td></tr>
                        <tr><td></td><td contenteditable="true" onblur="saveState()" class="editable-text">TERCER TURNO:</td><td><input type="number" class="col-1 data-input" data-id="m3-c1" oninput="updateCalculations()"></td><td><input type="number" class="col-2 data-input" data-id="m3-c2" oninput="updateCalculations()"></td></tr>
                        <tr class="total-row"><td></td><td class="text-right">TOTAL MOLIENDA (kgs):</td><td class="total-display" id="total-4-1">0</td><td class="total-display" id="total-4-2">0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- CONTROLES -->
        <div class="flex flex-wrap justify-center gap-4 mb-10 print:hidden">
            <button onclick="saveToHistory()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700 transition flex items-center gap-2">
                <span>üíæ</span> Guardar en Historial
            </button>
            <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition flex items-center gap-2">
                <span>üñ®Ô∏è</span> Imprimir / PDF
            </button>
            <button onclick="clearCurrentData()" class="bg-gray-500 text-white px-6 py-2 rounded shadow hover:bg-gray-600 transition flex items-center gap-2">
                <span>üßπ</span> Limpiar Tabla
            </button>
        </div>

        <!-- HISTORIAL -->
        <div class="print:hidden">
            <div class="flex justify-between items-center mb-4 border-b-2 border-gray-300 pb-2">
                <h2 class="text-xl font-bold text-gray-700">Historial de Registros</h2>
                <button onclick="downloadCSV()" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition">
                    üì• Descargar Excel (CSV)
                </button>
            </div>
            <div class="table-container">
                <table id="history-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="text-left text-gray-700">Fecha/Hora</th>
                            <th class="text-left text-gray-700">Resumen de Totales Guardados</th>
                            <th class="text-center text-gray-700" style="width: 100px;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Al iniciar, cargar todo el estado
        window.onload = function() {
            loadState();
            renderHistory();
        };

        // Calcula totales y guarda el estado actual autom√°ticamente
        function updateCalculations() {
            for(let i=1; i<=4; i++) {
                const table = document.getElementById(`table-${i}`);
                [1, 2].forEach(colNum => {
                    const inputs = table.querySelectorAll(`.col-${colNum}`);
                    let sum = 0;
                    inputs.forEach(input => sum += parseFloat(input.value) || 0);
                    document.getElementById(`total-${i}-${colNum}`).innerText = sum.toLocaleString();
                });
            }
            saveState();
        }

        // Guarda el contenido de inputs y textos editables en LocalStorage
        function saveState() {
            const state = {
                inputs: {},
                texts: {}
            };
            
            // Guardar inputs de n√∫meros
            document.querySelectorAll('.data-input').forEach(input => {
                state.inputs[input.dataset.id] = input.value;
            });

            // Guardar todos los textos editables (incluyendo t√≠tulos y notas)
            document.querySelectorAll('.editable-text').forEach((el, index) => {
                state.texts[index] = el.innerText;
            });

            localStorage.setItem('produccion_current_state', JSON.stringify(state));
        }

        // Recupera el contenido guardado al recargar
        function loadState() {
            const saved = localStorage.getItem('produccion_current_state');
            if (!saved) return;
            
            const state = JSON.parse(saved);
            
            // Restaurar inputs
            document.querySelectorAll('.data-input').forEach(input => {
                if(state.inputs[input.dataset.id]) {
                    input.value = state.inputs[input.dataset.id];
                }
            });

            // Restaurar textos editables
            document.querySelectorAll('.editable-text').forEach((el, index) => {
                if(state.texts[index]) {
                    el.innerText = state.texts[index];
                }
            });

            // Forzar rec√°lculo de totales visuales
            updateCalculations();
        }

        // Guarda una copia en el historial sin borrar la tabla actual
        function saveToHistory() {
            const data = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                totals: {
                    t1: [document.getElementById('total-1-1').innerText, document.getElementById('total-1-2').innerText],
                    t2: [document.getElementById('total-2-1').innerText, document.getElementById('total-2-2').innerText],
                    t3: [document.getElementById('total-3-1').innerText, document.getElementById('total-3-2').innerText],
                    t4: [document.getElementById('total-4-1').innerText, document.getElementById('total-4-2').innerText]
                }
            };

            let history = JSON.parse(localStorage.getItem('produccion_history') || '[]');
            history.unshift(data);
            localStorage.setItem('produccion_history', JSON.stringify(history));
            
            renderHistory();
            alert('Copia guardada en el historial. Los datos actuales se mantienen en la tabla.');
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('produccion_history') || '[]');
            const body = document.getElementById('history-body');
            body.innerHTML = '';

            if (history.length === 0) {
                body.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-4">No hay registros en el historial.</td></tr>';
                return;
            }

            history.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-sm">${entry.timestamp}</td>
                    <td class="text-xs text-gray-600 italic">
                        Rep: ${entry.totals.t1.join('/')} | Desp: ${entry.totals.t2.join('/')} | Har: ${entry.totals.t3.join('/')} | Mol: ${entry.totals.t4.join('/')}
                    </td>
                    <td class="text-center">
                        <button onclick="deleteHistoryEntry(${entry.id})" class="text-red-500 hover:text-red-700">Eliminar</button>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function deleteHistoryEntry(id) {
            if(confirm('¬øEliminar esta entrada del historial?')) {
                let history = JSON.parse(localStorage.getItem('produccion_history') || '[]');
                history = history.filter(e => e.id !== id);
                localStorage.setItem('produccion_history', JSON.stringify(history));
                renderHistory();
            }
        }

        function clearCurrentData() {
            if(confirm('ATENCI√ìN: Se borrar√°n todos los datos de la tabla actual. ¬øContinuar?')) {
                document.querySelectorAll('.data-input').forEach(i => i.value = '');
                updateCalculations();
                saveState(); // Guardar el estado vac√≠o
            }
        }

        function downloadCSV() {
            const history = JSON.parse(localStorage.getItem('produccion_history') || '[]');
            if (history.length === 0) return alert('No hay datos hist√≥ricos para descargar');

            let csv = 'Fecha,Reproceso 1,Reproceso 2,Desperdicio 1,Desperdicio 2,Harina 1,Harina 2,Molienda 1,Molienda 2\n';
            history.forEach(e => {
                csv += `"${e.timestamp}",${e.totals.t1[0]},${e.totals.t1[1]},${e.totals.t2[0]},${e.totals.t2[1]},${e.totals.t3[0]},${e.totals.t3[1]},${e.totals.t4[0]},${e.totals.t4[1]}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "registro_produccion.csv";
            link.click();
        }
    </script>
</body>
</html>


